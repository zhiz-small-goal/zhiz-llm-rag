---
title: HANDOFF snapshot (archived) - 2026-01-05
last_updated: 2026-01-06
status: archived
superseded_by: ../HANDOFF.md
version: 1.0
---

# ARCHIVED


- 本文件为历史快照（2026-01-05），**不作为当前生效口径**。
- 当前单一真源（SSOT）：`docs/explanation/HANDOFF.md`。

---

# 项目交接快照（RAG/检索演进）- 2026-01-05

## 目录
- [1. 当前目标与范围](#1-当前目标与范围)
- [2. 当前已落地能力](#2-当前已落地能力)
- [3. 基线指标与最新结论](#3-基线指标与最新结论)
- [4. 迁移期门禁策略（warning 过渡）](#4-迁移期门禁策略warning-过渡)
- [5. 端到端回归中的 model 字段含义与治理](#5-端到端回归中的-model-字段含义与治理)
- [6. 关键命令](#6-关键命令)
- [7. 关键文件清单](#7-关键文件清单)
- [8. 下一步建议（按最小改动优先）](#8-下一步建议按最小改动优先)
- [9. 新对话接手提示词（直接复制）](#9-新对话接手提示词直接复制)

---

## 1. 当前目标与范围

- **目标问题**：用户口语 query 与知识库“官方术语/文档标题”存在 vocabulary mismatch，导致 **dense topK 候选窗漏召回**，进而端到端 RAG 失败。
- **当前阶段**：
  - Stage-2：**检索回归**（retrieval-only）可分桶、可对照、可落盘证据。
  - E2E：**端到端回归**（retrieve + prompt + LLM）可区分“请求被拒绝(4xx/5xx)”与“超时(ReadTimeout)”。

---

## 2. 当前已落地能力

### 2.1 Stage-2（检索回归）已落地
- eval_cases 支持字段：
  - `bucket`：`oral|official|ambiguous`
  - `pair_id` / `concept_id`：同概念对照组（口语 vs 术语）
- eval_retrieval_report 输出：
  - `schema_version=2`
  - `metrics`（overall）与 `buckets`（按桶聚合）
  - `warnings`（迁移期缺字段/非法值等）
  - `run_meta`（argv、python、platform）用于复现

### 2.2 E2E（端到端回归）已落地
- LLM HTTP 调用失败时落盘：
  - `error_detail.status_code`
  - `error_detail.response_snippet`（截断正文）
  - 用于快速裁决：**是请求被拒绝**还是 **生成超时**

---

## 3. 基线指标与最新结论

> 说明：以下为“已补齐 bucket 的最新回归”口径（k=5，dense-only）。

- **Stage-2 检索回归**（k=5）：
  - overall hit_rate 约 **2/3**
  - oral 命中率 < official 命中率（口语桶仍为主要风险面）
- **端到端回归（E2E）**：
  - pass_rate 低于检索命中率是正常现象（还包含生成质量与 must_include 约束）
  - 已观测到两类失败：
    - **400 被拒绝**：服务端错误正文提示 **context length=4096 tokens**（需要减小输入预算或增大 ctx）
    - **ReadTimeout**：read_timeout=120s 内未返回（需要减负或延长 timeout）

---

## 4. 迁移期门禁策略（warning 过渡）

### 4.1 当前策略（过渡期）
- **缺 bucket**：允许运行，但写入 `warnings`（例如 `missing_bucket_default`），避免 silent failure。
- **非法 bucket**：建议直接 FAIL（避免统计失真）。
- 对照组质量：`pair_id` 缺失可先 warning，后续收紧。

### 4.2 收紧策略（建议触发器）
当满足以下条件时，将 warning 升级为 FAIL：
- `warnings` 连续 N 次回归接近 0（例如 < 1% cases）
- oral 桶样本量达到可解释规模（例如 ≥ 10，且覆盖多个 concept）
- 已形成若干高价值对照组（pair_id）用于趋势门禁

---

## 5. 端到端回归中的 model 字段含义与治理

### 5.1 现象
报告里出现 `model_field="gpt-3.5-turbo"` 往往是**客户端默认占位符**，不一定代表服务端真实加载模型。

### 5.2 正确做法
- 以 `GET /v1/models` 返回的 `data[].id` 为准，示例：
  - `qwen2.5-7b`
  - `qwen2.5-7b-instruct`
- 最佳实践：
  - CLI/配置默认 `--llm-model auto`
  - 运行时调用 `/models` 自动选择（优先 `*-instruct`），并把选择过程落盘到报告，确保审计可复核。

---

## 6. 关键命令

### 6.1 检索回归（Stage-2）
```bash
python tools/validate_eval_cases.py --root . --cases data_processed/eval/eval_cases.jsonl
python tools/run_eval_retrieval.py --root . --cases data_processed/eval/eval_cases.jsonl --db chroma_db --collection rag_chunks --k 5 --out data_processed/build_reports/eval_retrieval_report.json
```

### 6.2 端到端回归（E2E）
```bash
python tools/run_eval_rag.py --root . --db chroma_db --collection rag_chunks --k 5 --out data_processed/build_reports/eval_rag_report.json
```

### 6.3 取服务端真实模型 ID
```powershell
curl http://127.0.0.1:8000/v1/models
```

---

## 7. 关键文件清单

- `data_processed/eval/eval_cases.jsonl`（已补齐 bucket/pair_id）
- `data_processed/build_reports/eval_retrieval_report.json`（schema v2）
- `data_processed/build_reports/eval_rag_report.json`（含 error_detail）
- `docs/reference/EVAL_CASES_SCHEMA.md`
- `docs/howto/ORAL_OFFICIAL_RETRIEVAL_REGRESSION.md`

---

## 8. 下一步建议（按最小改动优先）

1) **k 扫描实验**（k=5/10/20）：裁决失败是“排序问题”还是“真漏召回”。
2) 对 `hit_at_k=false` 的失败用例，逐条判定：
   - expected_sources 是否过窄导致假失败（先修契约）
   - 若 k=20 仍失败：优先做 query 扩展（口语→术语映射），再考虑 hybrid（BM25 + 向量）与 RRF。
3) E2E 方面：
   - 400（ctx=4096）优先减小输入预算（context-max-chars、topK 注入、max_tokens）
   - ReadTimeout 优先减负，必要时再提高 read_timeout

---

## 9. 新对话接手提示词（直接复制）

> 你是“技术顾问+系统分析师”。我在维护一个本地 RAG/检索项目。当前核心问题是“口语 query 与官方术语不一致导致 topK 漏召回”。我已完成 eval_cases 分桶（oral/official）并生成检索回归与端到端回归报告。  
> 你的任务：  
> 1) 先基于我提供的 eval_cases.jsonl 与最新 eval_retrieval_report.json / eval_rag_report.json 进行诊断，区分是“标签/契约问题、排序问题、真漏召回、ctx 超限、超时”。  
> 2) 在不大改架构的前提下给出最小改动方案（含参数、脚本、门禁收紧触发器），并保持可回滚、可观测。  
> 3) 若涉及模型字段：以 GET /v1/models 返回 id 为准，不要使用占位符。  
> 我已采用 warning 作为迁移期门禁，请沿用并给出收紧策略。
