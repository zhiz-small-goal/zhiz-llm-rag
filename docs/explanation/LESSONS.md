---
title: Lessons / 经验库（可迁移）
version: 0.1
last_updated: 2026-01-06
scope: "跨 postmortem 的失败模式、控制点、门禁与清单"
owner: zhiz
---

# Lessons / 经验库（可迁移）

> 目的：把多次复盘里“可迁移的项目建设思维”从单篇 postmortem 中抽离出来，沉淀为**可检索、可复用、可演进**的长期资产。  
> 规则：这里只写“跨事件可复用”的内容；每条经验必须回链到至少 1 篇 postmortem 作为证据锚点（文件链接即可）。

## 目录
- [0. 使用与写入规则](#0-使用与写入规则)
- [1. 失败模式词表](#1-失败模式词表)
- [2. 控制点与门禁设计原则](#2-控制点与门禁设计原则)
- [3. 复用资产入口](#3-复用资产入口)
- [4. 经验条目模板](#4-经验条目模板)
- [5. 待办与清理规则](#5-待办与清理规则)

---

## 0. 使用与写入规则

- **单一真源（SSOT）**：本文件用于“原则/反模式/控制点/触发器”的汇总；事件细节仍留在各自 postmortem 中。
- **最小条目**：每条经验写成“模式 → 控制点 → 可执行动作 → 验收方式”，避免抽象口号。
- **必须回链**：每条经验至少链接 1 篇相关 postmortem（位于 `docs/postmortems/`）。
- **可演进**：当某条经验被证伪或出现更好的控制点，更新同一条目并记录变更原因（不要堆叠新条目造成重复）。

---

## 1. 失败模式词表

> 用于给经验条目打标签，便于统计与检索（与 postmortem 模板的模式枚举保持一致）。

- **契约漂移**：schema/接口/参数口径不一致
- **环境漂移**：多设备/多 venv/依赖版本不一致
- **入口不一致**：CLI/脚本/CI 走不同路径
- **不可观测**：缺关键日志/缺指标/缺探针
- **无回滚/不可逆改动**：修复难以撤销或验证
- **状态不一致**：缓存/产物/索引与源数据错位
- **文档漂移**：文档与代码/契约不一致

---

## 2. 控制点与门禁设计原则

1) **先定义不变量，再做优化**  
   - 控制点：先明确 PASS 条件与产物契约（例如 report schema / stamp / chunk 数量），再做速度或体验优化。  
   - 动作：把 PASS 条件固化为脚本或 CI 门禁（避免靠人工目测）。

2) **入口统一优先于局部修补**  
   - 控制点：同一条主流程尽量让 CLI / 脚本 / CI 复用同一入口与参数解析，避免“看似跑通但走了不同代码路径”。  
   - 动作：为入口点写一致性检查（例如 entrypoints / import drift 检查）。

3) **先可观测，再可控**  
   - 控制点：缺日志/缺探针时，根因分析会退化为猜测。  
   - 动作：先补齐最小观测（probe、版本打印、产物摘要），再谈门禁收紧。

4) **默认可回滚**  
   - 控制点：任何会影响统计口径/契约的改动，都必须明确回滚点与验收命令。  
   - 动作：把“回滚步骤 + 验收命令”写进行动项表，并在 PR/commit 中保留可撤销性。

---

## 3. 复用资产入口

- **Preflight（重构/换机/换环境后必跑）**：见 [PREFLIGHT_CHECKLIST](../howto/PREFLIGHT_CHECKLIST.md)
- **PR/CI Lite 门禁（快速回归）**：见 [ci_pr_gates](../howto/ci_pr_gates.md)
- **Postmortems 索引**：见 [docs/postmortems/INDEX.md](../postmortems/INDEX.md)

---

## 4. 经验条目模板

> 复制以下模板新增条目；尽量控制在 15–25 行内。

### 条目：<一句话标题>
- 标签（失败模式）：`<从词表选择 1–3 个>`
- 适用场景：<何时会遇到>
- 触发/现象：<可观测现象>
- 根因机制（简述）：<因果链，避免口号>
- 缺失控制点：<本该更早拦住它的门禁/检查>
- 可执行动作：
  - A1：<做什么（命令/改动点）>
  - A2：<做什么（命令/改动点）>
- 验收方式（PASS 条件）：<命令 + PASS 字段>
- 回链证据（至少 1 篇 postmortem）：
  - <链接：`docs/postmortems/<file>.md`>

---

## 5. 待办与清理规则

- 待办：为现有 postmortems 逐步补齐“标签（失败模式）”与“对应经验条目”。建议每次复盘写完只补 1–2 条，不做大扫除式重构。
- 清理规则：若同一问题在 3 篇以上 postmortem 中重复出现，必须：
  - 合并为 1 条经验条目（SSOT）
  - 并在 `../howto/PREFLIGHT_CHECKLIST.md` 中增加或收紧对应检查项
## 2026-01-07｜docs↔code 对齐与文档门禁治理（回链）

- 证据锚点：
  - [Postmortem：docs↔code 对齐 + 缺失脚本补齐 + 文档门禁增强 + 输出可读性优化](../postmortems/2026-01-07_postmortem_docs_code_alignment_and_doc_gates.md)

### 原则库（Principles）
1) **引用语义分类优先于字符串检查**：区分 repo 文件 / 运行时工件 / 计划项 / 外部材料，再决定“必须存在/允许不存在/必须占位”。
2) **门禁可信度优先**：strict 输出应以“少而准”为目标；误报会长期腐蚀执行力。
3) **SSOT + redirect**：同一事实只允许 1 份权威正文，其余位置用链接索引，禁止双写漂移。
4) **先可读，再可控**：控制台报告需分段留白，否则人类 review 吞吐下降，导致收敛变慢。

### 反模式库（Anti-patterns）
- 文档写 `tools/xxx.py` 像“已内置”，但仓库缺失且不标注计划项。
- 用裸文件名（如 `inventory.csv`、`check.json`）指代运行产物且不声明生成与路径约定，导致门禁误报或误导。
- “修复前后命令相同”，但隐含修复点其实是 cwd/入口点约束。
- 模板/Reference 文档内塞入工作流细节，导致职责混杂与维护困难（应拆成 How-to）。

### 控制点与门禁（Controls）
- Doc-gate（严格验证不改文件）：  
  `python tools\verify_postmortems_and_troubleshooting.py --no-fix --strict`
- Inventory 输入集合漂移 gate（需要时启用）：  
  `python tools\check_inventory_build.py --compare-snapshot <snapshot> --strict`

