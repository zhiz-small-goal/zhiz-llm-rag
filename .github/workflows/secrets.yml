name: secrets-scan

on:
  pull_request:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # NOTE:
      # This workflow intentionally avoids third-party `uses:` actions (e.g. gitleaks/gitleaks-action),
      # because the repo/org Actions policy only allows GitHub-created actions and org-owned actions.
      # Instead we install the gitleaks CLI as a pinned release artifact and run it via `run:`.

      - name: Install gitleaks (pinned + checksum verified)
        shell: bash
        run: |
          set -euo pipefail

          # Pin a specific gitleaks version for reproducibility.
          # To upgrade: bump VER and keep the checksum verification in place.
          VER="8.30.0"
          TARBALL="gitleaks_${VER}_linux_x64.tar.gz"
          CHECKSUMS="gitleaks_${VER}_checksums.txt"

          curl -fsSL -o "${TARBALL}" "https://github.com/gitleaks/gitleaks/releases/download/v${VER}/${TARBALL}"
          curl -fsSL -o "${CHECKSUMS}" "https://github.com/gitleaks/gitleaks/releases/download/v${VER}/${CHECKSUMS}"

          # Verify sha256 from the official checksums file.
          grep " ${TARBALL}$" "${CHECKSUMS}" | sha256sum -c -

          tar -xzf "${TARBALL}" gitleaks
          ./gitleaks version

      - name: Run gitleaks (git history)
        shell: bash
        run: |
          set -euo pipefail

          # Config resolution:
          # - We pass --config explicitly to avoid ambiguity across working directories.
          # - The repo provides a minimal .gitleaks.toml that extends default rules.
          ./gitleaks git             --config .gitleaks.toml             --redact             --report-format json             --report-path gitleaks-report.json             --exit-code 1             .

      - name: Report (summary only)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if [ -f gitleaks-report.json ]; then
            echo "gitleaks-report.json generated: $(wc -c < gitleaks-report.json) bytes"
            # Avoid printing full findings into CI logs. Use the step output from gitleaks itself,
            # or download the report from the workflow run if you later allow artifact uploads.
          else
            echo "gitleaks-report.json not found (gitleaks may have failed before writing a report)."
          fi
